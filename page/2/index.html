<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT">










<meta property="og:type" content="website">
<meta property="og:title" content="Laurel Blog">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="Laurel Blog">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Laurel Blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/page/2/">





  <title>Laurel Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Laurel Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">许多年前，曾是个朴素的少年</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/15/webpack中按需打包的babel插件实现/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Laurel">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Laurel Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/15/webpack中按需打包的babel插件实现/" itemprop="url">webpack中按需打包的babel插件实现</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-15T11:17:37+08:00">
                2019-04-15
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="babel插件实现按需打包的功能"><a href="#babel插件实现按需打包的功能" class="headerlink" title="babel插件实现按需打包的功能"></a>babel插件实现按需打包的功能</h2><h3 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import &#123;flatten,join&#125; from &apos;lodash&apos;;</span><br><span class="line"></span><br><span class="line">转化成=========&gt;</span><br><span class="line"></span><br><span class="line">import flatten from &apos;lodash/flatten&apos;;</span><br><span class="line">import join from &apos;lodash/join&apos;;</span><br></pre></td></tr></table></figure>

<h3 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h3><ul>
<li><p>配置.babelrc</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"plugins"</span>: [</span><br><span class="line">        [</span><br><span class="line">            <span class="string">"babel-plugin-sui-import"</span>, // 这个是自己写的插件名</span><br><span class="line">            &#123;</span><br><span class="line">                "libraryName": "vant", // 在引用哪个库时候使用自己写的这个插件</span><br><span class="line">                "libraryDirectory": "lib"</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>引入脚本，进行对比</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// import &#123;flatten,join&#125; from 'lodash' // 打包后大小：483k</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> flatten <span class="keyword">from</span> <span class="string">'lodash/flatten'</span> <span class="comment">// 打包后大小：21.3K</span></span><br><span class="line"><span class="keyword">import</span> join <span class="keyword">from</span> <span class="string">'lodash/join'</span></span><br></pre></td></tr></table></figure>

<p>两种引入方式的抽象语法树的差别，只是IMportDeclaration不同</p>
</li>
<li><p>整理插件代码到node_modules文件中</p>
<p>babel插件的文件名，必须以babel-plugin-xxx命名，否则引入不成功；babel插件返回的是一个对象，里面是个访问者模式的visitor对象，里面是转化代码</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> t = <span class="built_in">require</span>(<span class="string">'@babel/types'</span>);</span><br><span class="line"><span class="keyword">const</span> humps = <span class="built_in">require</span>(<span class="string">'humps'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        visitor: &#123;</span><br><span class="line">            ImportDeclaration(</span><br><span class="line">                path,</span><br><span class="line">                &#123;</span><br><span class="line">                opts: &#123; libraryName, libraryDirectory &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ) &#123;</span><br><span class="line">                <span class="keyword">if</span> (!t.isStringLiteral(path.node.source, &#123; <span class="attr">value</span>: libraryName &#125;)) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">const</span> specifiers = path.node.specifiers;</span><br><span class="line">                <span class="keyword">const</span> declarations = specifiers.map(<span class="function"><span class="params">specifier</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">return</span> t.ImportDeclaration(</span><br><span class="line">                        [t.importDefaultSpecifier(specifier.local)],</span><br><span class="line">                        t.StringLiteral(</span><br><span class="line">                        <span class="string">`<span class="subst">$&#123;libraryName&#125;</span>/<span class="subst">$&#123;libraryDirectory&#125;</span>/<span class="subst">$&#123;humps.camelize(</span></span></span><br><span class="line"><span class="string"><span class="subst">                            specifier.local.name</span></span></span><br><span class="line"><span class="string"><span class="subst">                        )&#125;</span>`</span></span><br><span class="line">                        )</span><br><span class="line">                    );</span><br><span class="line">                &#125;);</span><br><span class="line">                path.replaceWithMultiple(declarations);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/15/webpack多入口文件页面配置/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Laurel">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Laurel Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/15/webpack多入口文件页面配置/" itemprop="url">webpack多入口文件页面配置</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-15T11:16:00+08:00">
                2019-04-15
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/interview/" itemprop="url" rel="index">
                    <span itemprop="name">interview</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="webpack多入口文件页面配置"><a href="#webpack多入口文件页面配置" class="headerlink" title="webpack多入口文件页面配置"></a>webpack多入口文件页面配置</h2><p>webpack的多页面文件的打包配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">单页应用程序和多页应用程序的webpack配置文件绝大部分是相同的，loader、output、plugins这些基本不需改动；</span><br><span class="line"></span><br><span class="line">需要改动的一般都是入口文件entry，如果用到抽离css样式的插件extract-text-webpack-plugin、自动模板插件html-webpack-plugin,需要进行额外的改写。</span><br></pre></td></tr></table></figure>

<ul>
<li><p>entry</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 多页应用程序，则需要多个入口文件(如：项目里有多个入口文件)</span></span><br><span class="line">entry: &#123;</span><br><span class="line">    home: resolve(__dirname, <span class="string">'src/home/index.js'</span>),</span><br><span class="line">    about: resolve(__dirname, <span class="string">'src/about/index.js'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>extract-text-webpack-plugin</p>
<p>主要是为了抽离css样式，防止将样式打包在js中引起页面样式加载错乱或者js脚本体积过大等情况；</p>
<ol>
<li><p>多页程序，因为存在多个入口文件以及对应的多个页面，每个页面都有自己的css样式，所以需要为每个页面各自配置:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//为每个页面定义一个 ExtractTextPlugin</span></span><br><span class="line"><span class="keyword">const</span> homeExtractCss = <span class="keyword">new</span> ExtractTextPlugin(<span class="string">'home/[name].[contenthash].css'</span>)</span><br><span class="line"><span class="keyword">const</span> aboutExtractCss = <span class="keyword">new</span> ExtractTextPlugin(<span class="string">'about/[name].[contenthash].css'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 多页应用程序，则需要多个入口文件(如：项目里有多个入口文件)</span></span><br><span class="line">plugins: [</span><br><span class="line">    homeExtractCss</span><br><span class="line">    aboutExtractCss</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>每个页面只需要知己的css样式，不需要别的页面css样式，以防样式覆盖和代码冗余，需要对loader配置进行修改：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [ <span class="comment">// 每个页面的 ExtractTextPlugin 只处理这个页面的样式文件</span></span><br><span class="line">        &#123;</span><br><span class="line">            test: <span class="regexp">/src(\\|\/)home(\\|\/)css(\\|\/).*\.(css|scss)$/</span>,</span><br><span class="line">            use: homeExtractCss.extract(&#123;</span><br><span class="line">                fallback: <span class="string">'style-loader'</span>,</span><br><span class="line">                use: [<span class="string">'css-loader'</span>, <span class="string">'postcss-loader'</span>, <span class="string">'sass-loader'</span>]</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;,  &#123;</span><br><span class="line">            test: <span class="regexp">/src(\\|\/)about(\\|\/)css(\\|\/).*\.(css|scss)$/</span>,</span><br><span class="line">            use: aboutExtractCss.extract(&#123;</span><br><span class="line">                fallback: <span class="string">'style-loader'</span>,</span><br><span class="line">                use: [<span class="string">'css-loader'</span>, <span class="string">'postcss-loader'</span>, <span class="string">'sass-loader'</span>]</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 每个页面都有各自的 ExtractTextPlugin，所以需要都声明一遍</span></span><br><span class="line">plugins: [homeExtractCss, aboutExtractCss]</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>html-webpack-plugin<br>在单页应用程序和多页应用程序中的 webpack配置没什么区别，有几个页面，就对每个页面进行配置即可</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> HtmlWebpackPlugin(&#123;</span><br><span class="line">    filename: <span class="string">'about/about.html'</span>, <span class="comment">// 'home/home.html'</span></span><br><span class="line">    template: <span class="string">'src/about/html/index.html'</span>, <span class="comment">// 'src/about/html/index.html'</span></span><br><span class="line">    inject: <span class="literal">true</span>,</span><br><span class="line">    minify: &#123;</span><br><span class="line">        removeComments: <span class="literal">true</span>,</span><br><span class="line">        collapseWhitespace: <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>自动配置<br>每个页面都是 src/目录下的一个文件夹，这个文件夹中有两个子目录，分别存放这个页面的模板 html，样式文件 css，还有一个入口文件 index.js</p>
<p>通过一个通用方法来获取所有的页面名称（每个页面都是 ./src下的一个目录，目录名即为页面名）：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getEntry</span> (<span class="params"></span>) </span>&#123; <span class="comment">// 借助glob库，遍历.src/目录下具有这种规律src/**/html/*.html的子目录，通过正则匹配出子目录的名称</span></span><br><span class="line">  <span class="keyword">let</span> globPath = <span class="string">'src/**/html/*.html'</span></span><br><span class="line">  <span class="comment">// (\/|\\\\) 这种写法是为了兼容 windows和 mac系统目录路径的不同写法    </span></span><br><span class="line">  <span class="keyword">let</span> pathDir = <span class="string">'src(\/|\\\\)(.*?)(\/|\\\\)html'</span>    </span><br><span class="line">  <span class="keyword">let</span> files = glob.sync(globPath)    </span><br><span class="line">  <span class="keyword">let</span> dirname, entries = []    </span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; files.length; i++) &#123;        </span><br><span class="line">    dirname = path.dirname(files[i])        </span><br><span class="line">    entries.push(dirname.replace(<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">'^'</span> + pathDir), <span class="string">'$2'</span>))    </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> entries</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/12/vue中computed分析&vuex原理/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Laurel">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Laurel Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/12/vue中computed分析&vuex原理/" itemprop="url">vue中computed分析&vue原理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-12T12:20:36+08:00">
                2019-04-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="vuex原理"><a href="#vuex原理" class="headerlink" title="vuex原理"></a>vuex原理</h3><p>vuex依赖于vue的computed依赖检测系统以及插件系统</p>
<p>Vuex.store除了初始化以外还有重置VM方法，即resetStoreVM(this, state).<br>本质是将传入的state作为一个隐藏的vue组件的data，commit操作本质是修改这个组件的data值。结合computed，修改被defineReactive代理的对象值后，会将其收集到的依赖的watcher中的dirty设置为true，等下一次访问该watcher中的值后重新获取最新值。可推出：store._vm.$data.$$state === store.state</p>
<p>vuex的实现方式使用了vue自身的响应式设计，依赖监听、依赖收集都属于vue对对象Property set get方式的代理劫持。即vuex工作原理：vuex中的store本质就是没有template的隐藏着的vue组件</p>
<h3 id="computed"><a href="#computed" class="headerlink" title="computed"></a>computed</h3><ul>
<li>计算属性如何与属性建立依赖关系</li>
<li>属性发生变化如何通知到计算属性重新计算</li>
</ul>
<p>依赖收集、动态计算的流程：</p>
<ol>
<li>data属性初始化getter setter</li>
<li>computed 计算属性初始化，提供的函数用作属性(vm.reverseMsg)的getter</li>
<li>当首次获取计算属性(vm.reverseMsg)的值时，Dep开始依赖收集</li>
<li>在执行msg getter方法时，如果Dep处于依赖收集状态，则判定 msg为reverseMsg的依赖，并建立依赖关系</li>
<li>当 msg 发生变化时，根据依赖关系，触发 reverseMsg 的重新计算。</li>
</ol>
<h3 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h3><ul>
<li>初始化组件的state方法：initState<ul>
<li>当组件实例化时会自动触发，主要完成了初始化data、props、computed、watch等属性，以及initData和initComputed</li>
<li>initData<ul>
<li>将vue的data传入observer方法（该方法本质是实例化了一个Observer对象）</li>
<li>Observer里的重点：new Dep对象；给data的所有属性调用defineReactive</li>
<li>defineReactive是vue实现 MDV(Model-Driven-View)的基础，就是代理数据的get，set方法。当数据修改或获取的时候，能够感知<ul>
<li>在给具体属性调用defineReactive方法时，都会为该属性生成唯一的dep对象。</li>
<li>重新定义data当中的属性，对get和set进行代理</li>
<li>get里收集依赖，dep.depend() // reversedMessage为什么会跟着message变化的原因<ul>
<li>dep.depend()是将该dep加入watcher的newDeps中,同时将所访问当前属性的dep对象中的subs插入当前Dep.target的watcher</li>
</ul>
</li>
<li>set里通知依赖进行更新，dep.notify()<ul>
<li>notify方法即将加入该dep的watcher全部更新，即当修改data中某个属性值时，会同时调用dep.notify()来更新依赖该值的所有watcher</li>
</ul>
</li>
</ul>
</li>
<li>Dep 是 vue 实现的一个处理依赖关系的对象，主要起到一个纽带的作用，就是连接 reactive data 与 watcher<ul>
<li>重点方法：addSub()；depend()；notify() // 更新watcher 的值</li>
<li>当首次计算 computed 属性的值时，Dep 将会在计算期间对依赖进行收集</li>
<li>pushTarget：在一次依赖收集期间，如果有其他依赖收集任务开始，将会把当前 target 暂存到 targetStack，先进行其他 target 的依赖收集，</li>
<li>popTarget: 当嵌套的依赖收集任务完成后，将 target 恢复为上一层的 Watcher，并继续做依赖收集</li>
</ul>
</li>
</ul>
</li>
<li>initComputed<ul>
<li>对每一个属性都生成了一个属于自己的Watcher实例，并将 { lazy: true }作为options传入<ul>
<li>在computed生成的watcher，会将watcher的lazy设置为true,以减少计算量。因此，实例化时，this.dirty也是true,标明数据需要更新操作</li>
<li>先记住现在computed中初始化对各个属性生成的watcher的dirty和lazy都设置为了true。同时，将computed传入的属性值（一般为funtion）,放入watcher的getter中保存起来。</li>
</ul>
</li>
<li>对每一个属性调用了defineComputed方法(本质和data一样，代理了自己的set和get方法)<ul>
<li>当第一次访问computed中的值时，会因为初始化watcher.dirty = watcher.lazy的原因，从而调用watcher.evalute()方法，evalute()方法就是调用了watcher实例中的get方法以及设置dirty = false,我们将这两个方法放在一起<ul>
<li>get方法： 调用了pushTarget方法，其作用就是将Dep.target设置为所传入的watcher,即所访问的computed中属性的watcher</li>
<li>this.getter 在Watcher构建函数中提到，本质就是用户传入的方法，也就是说，this.getter.call(vm, vm)就会调用用户自己声明的方法，那么如果方法里面用到了 this.data中的值或者其他被用defineReactive包装过的对象，那么，访问this.data.或者其他被defineReactive包装过的属性，是不是就会访问被代理的该属性的get方法（computed的watcher依赖了this.data的dep）</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li>拆解获取依赖并更新的过程：<ul>
<li>初始化 data和computed，分别代理其get和set方法，对data中的所有属性生成唯一的dep实例</li>
<li>对computed中的属性A生成唯一的watcher，并保存到vm._computedWatchers中</li>
<li>访问计算属性A，设置Dep.target指向计算属性A的watcher，调用该属性具体的方法A()</li>
<li>方法中访问属性this.a，即会调用this.a代理的get方法，将this.a的dep加入计算属性A的watcher，同时该dep中的subs添加这个watcher</li>
<li>设置vm.a = ‘new a’，调用a代理的set方法触发dep的notify方法</li>
<li>因为是computed属性，只是将watcher中的dirty设置为true</li>
<li>查询计算属性vm.A，访问其get方法时，得知计算属性A的watcher.dirty为true,调用watcher.evaluate()方法获取新的值。</li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/12/webpack-loader/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Laurel">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Laurel Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/12/webpack-loader/" itemprop="url">webpack-loader</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-12T11:22:41+08:00">
                2019-04-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="loader"><a href="#loader" class="headerlink" title="loader"></a>loader</h2><p>(<a href="https://webpack.docschina.org/loaders/" target="_blank" rel="noopener">https://webpack.docschina.org/loaders/</a>)</p>
<h3 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h3><p>webpack可以使用loader来预处理文件，允许打包除JS之外的文件。用于对模块的源代码进行转换。<br>loader 可以将文件从不同的语言（如 TypeScript）转换为 JavaScript 或将内联图像转换为 data URL。loader 甚至允许你直接在 JavaScript 模块中 import CSS文件！</p>
<p>类型：</p>
<ul>
<li>文件：<ul>
<li>raw-loader：加载文件原始内容（utf-8）</li>
<li>val-loader： 将代码作为模块执行，并将 exports 转为 JS 代码</li>
<li>file-loader： 将文件发送到输出文件夹，并返回（相对）URL</li>
<li>url-loader 像 file loader 一样工作，但如果文件小于字节限制，可以返回 data URL</li>
<li>ref-loader 手动创建所有文件之间的依赖关系</li>
</ul>
</li>
<li>JSON：<ul>
<li>json-loader 加载 JSON 文件（默认包含）</li>
<li>json5-loader 加载和转译 JSON 5 文件</li>
<li>cson-loader 加载和转译 CSON 文件</li>
</ul>
</li>
<li>转译(transpiling)<ul>
<li>script-loader: 在全局上下文中执行一次 JavaScript 文件（如在 script 标签），不需要解析</li>
<li>babel-loader 加载 ES2015+ 代码，然后使用 Babel 转译为 ES5</li>
<li>buble-loader 使用 Bublé 加载 ES2015+ 代码，并且将代码转译为 ES5</li>
<li>traceur-loader 加载 ES2015+ 代码，然后使用 Traceur 转译为 ES5</li>
<li>ts-loader 或 awesome-typescript-loader 像 JavaScript 一样加载TypeScript 2.0+</li>
<li>coffee-loader 像 JavaScript 一样加载 CoffeeScript</li>
<li>fengari-loader 使用 fengari 加载 Lua 代码</li>
</ul>
</li>
<li>模板(templating)<ul>
<li>html-loader：导出html为字符串，需要引用静态资源</li>
<li>pug-loader：加载Pug模板并返回一个函数</li>
<li>markdown-loader：将markdown转译为HTML</li>
<li>react-markdown-loader 使用 markdown-parse parser(解析器) 将 Markdown 编译为 React 组件</li>
<li>posthtml-loader 使用 PostHTML 加载并转换 HTML 文件</li>
<li>handlebars-loader 将 Handlebars 转移为 HTML</li>
<li>markup-inline-loader 将内联的 SVG/MathML 文件转换为 HTML。在应用于图标字体，或将 CSS 动画应用于 SVG 时非常有用。</li>
<li>twig-loader 编译 Twig 模板，然后返回一个函数</li>
</ul>
</li>
<li>样式：<ul>
<li>style-loader 将模块的导出作为样式添加到 DOM 中</li>
<li>css-loader 解析 CSS 文件后，使用 import 加载，并且返回 CSS 代码</li>
<li>less-loader 加载和转译 LESS 文件</li>
<li>sass-loader 加载和转译 SASS/SCSS 文件</li>
<li>postcss-loader 使用 PostCSS 加载和转译 CSS/SSS 文件</li>
<li>stylus-loader 加载和转译 Stylus 文件</li>
</ul>
</li>
<li>代码检查和测试(linting &amp;&amp; testing)<ul>
<li>mocha-loader 使用 mocha 测试（浏览器/NodeJS）</li>
<li>eslint-loader PreLoader，使用 ESLint 清理代码</li>
<li>jshint-loader PreLoader，使用 JSHint 清理代码</li>
<li>jscs-loader PreLoader，使用 JSCS 检查代码样式</li>
<li>coverjs-loader PreLoader，使用 CoverJS 确定测试覆盖率</li>
</ul>
</li>
<li>框架(frameworks)<ul>
<li>vue-loader 加载和转译 Vue 组件</li>
<li>polymer-loader 使用选择预处理器(preprocessor)处理，并且 require() 类似一等模块(first-class)的 Web 组件</li>
<li>angular2-template-loader 加载和转译 Angular 组件</li>
</ul>
</li>
</ul>
<h3 id="使用loader（3种方式）"><a href="#使用loader（3种方式）" class="headerlink" title="使用loader（3种方式）"></a>使用loader（3种方式）</h3><ol>
<li>配置：在 webpack.config.js 文件中指定 loader。<ul>
<li>module.rules 允许你在 webpack 配置中指定多个 loader。<ul>
<li>rules：数组，指明各个loader。它会作用于匹配到 test 属性所指定规则的每一个文件</li>
<li>use：use 指明需要对匹配的文件应用那个loader</li>
</ul>
</li>
<li>loader 从右到左地取值(evaluate)/执行(execute)</li>
</ul>
</li>
<li>内联：在每个 import 语句中显式指定 loader。<ul>
<li>import Styles from ‘style-loader!css-loader?modules!./styles.css’;</li>
<li>使用 ! 将资源中的 loader 分开。每个部分都会相对于当前目录解析。</li>
</ul>
</li>
<li>CLI：在 shell 命令中指定它们<ul>
<li>webpack –module-bind jade-loader –module-bind ‘css=style-loader!css-loader’</li>
</ul>
</li>
</ol>
<h3 id="loader特性"><a href="#loader特性" class="headerlink" title="loader特性"></a>loader特性</h3><ul>
<li>loader 支持链式传递。链中的每个 loader 会将转换应用在已处理过的资源上。一组链式的 loader 将按照相反的顺序执行。链中的第一个 loader 将其结果（也就是应用过转换后的资源）传递给下一个 loader，依此类推。最后，链中的最后一个 loader，返回 webpack 期望 JavaScript。</li>
<li>loader 可以是同步的，也可以是异步的。</li>
<li>loader 运行在 Node.js 中，并且能够执行任何 Node.js 能做到的操作。</li>
<li>loader 可以通过 options 对象配置（仍然支持使用 query 参数来设置选项，但是这种方式已被废弃）。</li>
<li>除了常见的通过 package.json 的 main 来将一个 npm 模块导出为 loader，还可以在 module.rules 中使用 loader 字段直接引用一个模块。</li>
<li>插件(plugin)可以为 loader 带来更多特性。</li>
<li>loader 能够产生额外的任意文件。</li>
</ul>
<h3 id="babel-loader"><a href="#babel-loader" class="headerlink" title="babel-loader"></a>babel-loader</h3><p>允许你使用 Babel 和 webpack 转译 JavaScript 文件。<br>安装：npm install -D babel-loader @babel/core @babel/preset-env webpack</p>
<p>使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">module: &#123;</span><br><span class="line">  rules: [</span><br><span class="line">    &#123;</span><br><span class="line">      test: /\.m?js$/,</span><br><span class="line">      exclude: /(node_modules|bower_components)/,</span><br><span class="line">      use: &#123;</span><br><span class="line">        loader: &apos;babel-loader&apos;,</span><br><span class="line">        options: &#123; // 向 loader 传递 options 选项：</span><br><span class="line">          presets: [&apos;@babel/preset-env&apos;]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>优化：</p>
<ul>
<li>解决babel-loader很慢<ul>
<li>确保转译尽可能少的文件</li>
<li>使用exclude排除不需要的源代码</li>
<li>使用 <code>cacheDirectory</code> 选项，会将转译的结果缓存到文件系统中。</li>
</ul>
</li>
<li>Babel 在每个文件都插入了辅助代码，使代码体积过大<ul>
<li>Babel对一些公共方法使用了非常小的辅助代码(如 _extend)。默认情况下会被添加到每一个需要它的文件中,而babel-runtime供编译模块复用工具函数</li>
<li>可以引入Babel runtime作为一个独立模块，来避免重复引入</li>
<li>禁用Babe自动对每个文件的runtime注入，而是引入 @babel/plugin-transform-runtime 并且使所有辅助代码从这里引用</li>
</ul>
</li>
<li>transform-runtime &amp; babel-polyfill<ul>
<li>Babel默认只转换新的JS语法，而不转换新的 API(如：Object.assign)，使用 babel-polyfill，转译新的API</li>
<li>Babel 转译后的代码要实现源代码同样的功能需要借助一些帮助函数，可能会重复出现在一些模块里，导致编译后的代码体积变大，webpack提供了单独的包 babel-runtime 供编译模块复用工具函数<ul>
<li>babel 还为源代码的非实例方法和babel-runtime/helps 下的工具函数自动引用了 polyfill。这样可以避免污染全局命名空间，非常适合于 JavaScript 库和工具包的实现</li>
</ul>
</li>
<li>总结：<ul>
<li>具体项目还是需要使用 babel-polyfill，只使用 babel-runtime 的话，实例方法不能正常工作</li>
<li>JS库和工具可以使用 babel-runtime，在实际项目中使用这些库和工具，需要该项目本身提供polyfill；</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>自定义loader：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- babel-loader 提供了一个 loader-builder 工具函数，允许用户为 Babel 处理过的每个文件添加自定义处理选项。</span><br></pre></td></tr></table></figure>

<h3 id="css-loader"><a href="#css-loader" class="headerlink" title="css-loader"></a>css-loader</h3><p>css-loader解释@import和url()并解析它们<br>安装：npm install –save-dev css-loader</p>
<h3 id="sass-loader"><a href="#sass-loader" class="headerlink" title="sass-loader"></a>sass-loader</h3><p>加载Sass/Scss文件并且编译成CSS，依赖node-sass<br>安装:npm install sass-loader node-sass webpack –save-dev</p>
<p>使用:</p>
<ul>
<li><p>通过将 style-loader 和 css-loader 与 sass-loader 链式调用，可以立刻将样式作用在 DOM 元素</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">module: &#123;</span><br><span class="line">    rules: [&#123;</span><br><span class="line">        test: /\.scss$/,</span><br><span class="line">        use: [</span><br><span class="line">            &quot;style-loader&quot;, // 将 JS 字符串生成为 style 节点</span><br><span class="line">            &quot;css-loader&quot;, // 将 CSS 转化成 CommonJS 模块</span><br><span class="line">            &quot;sass-loader&quot; // 将 Sass 编译成 CSS，默认使用 Node Sass</span><br><span class="line">        ]</span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>生产环境下通常使用mini-css-extract-plugin将样式表抽里程专门的单独文件。</p>
</li>
<li><p>提取样式表：extract-loader；mini-css-extract-plugin</p>
</li>
</ul>
<h3 id="file-loader"><a href="#file-loader" class="headerlink" title="file-loader"></a>file-loader</h3><p>file-loader将文件上的import/require()解析为url，并将文件发送到输出目录中。</p>
<ul>
<li>默认情况下，生成文件的文件名，是文件内容的 MD5 哈希值，并会保留所引用资源的原始扩展名</li>
<li>选项：<ul>
<li>name：为目标文件指定自定义文件名模板</li>
<li>outputPath： 指定放置目标文件的文件系统路径</li>
<li>publicPath：指定目标文件的自定义公共路径</li>
<li>context：指定自定义文件上下文</li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/12/ServiceWorker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Laurel">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Laurel Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/12/ServiceWorker/" itemprop="url">ServiceWorker</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-12T10:24:39+08:00">
                2019-04-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Service-Worker-生命周期"><a href="#Service-Worker-生命周期" class="headerlink" title="Service Worker 生命周期"></a>Service Worker 生命周期</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Service Worker 脚本通过 navigator.serviceWorker.register 方法注册到页面。Service Worker 从注册开始需要先 install, 如果 install 成功, 接下来需要 activate, 然后才能接管页面。但是如果页面被先前的 Service Worker 控制着, 那么它会停留在 installed(waiting) 这个阶段等到页面重新打开才会接管页面, 或者可以通过调用 self.skipWaiting() 方法跳过等待</span><br></pre></td></tr></table></figure>

<ul>
<li>过程：<ul>
<li>parsed：注册完成，脚本解析成功，尚未安装</li>
<li>installing：对应Service Worker脚本install事件，如果事件里有event.waitUntil()则会等待传入的Promise完成才会成功</li>
<li>installed(waiting): 页面被旧的 Service Worker 脚本控制, 所以当前的脚本尚未激活。可以通过 self.skipWaiting() 激活新的 Service Worker</li>
<li>activating: 对应 Service Worker 脚本 activate 事件执行, 如果事件里有 event.waitUntil() 则会等待这个 Promise 完成才会成功。这时可以调用 Clients.claim() 接管页面</li>
<li>activated: 激活成功, 可以处理 fetch, message 等事件</li>
<li>redundant: 安装失败, 或者激活失败, 或者被新的 Service Worker 替代掉</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Service Worker脚本最常用的功能是截获请求和缓存资源文件，可绑定在这些事件上：</span><br><span class="line"></span><br><span class="line">- install事件中，抓取资源进行缓存；</span><br><span class="line">- activate事件中，遍历缓存，清除过期的资源；</span><br><span class="line">- fetch事件中，拦截请求，查询缓存或网络，返回请求的资源。</span><br></pre></td></tr></table></figure>

<ol>
<li>缓存策略：<br>处在 activated 状态的 Service Worker 可以拦截作用范围下的页面的网络请求, 由 Service Worker 监听 fetch 事件来决定请求如何响应</li>
</ol>
<h3 id="全局变量"><a href="#全局变量" class="headerlink" title="全局变量"></a>全局变量</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">self: 表示 Service Worker 作用域, 也是全局变量</span><br><span class="line">caches: 表示缓存，用来缓存外部资源</span><br><span class="line">skipWaiting: 表示强制当前处在 waiting 状态的脚本进入 activate 状态</span><br><span class="line">clients: 表示 Service Worker 接管的页面</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/12/Node内存泄露/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Laurel">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Laurel Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/12/Node内存泄露/" itemprop="url">Node内存泄露</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-12T10:20:36+08:00">
                2019-04-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="Node内存泄露"><a href="#Node内存泄露" class="headerlink" title="Node内存泄露"></a>Node内存泄露</h3><ul>
<li><p>问题：</p>
<p>我们的应用中有时响应会很慢，甚至没有响应</p>
<p>每天访问量在特定时间段会有大范围波动，但是整体比较平稳 。</p>
</li>
<li><p>分析：</p>
<p>正常情况下node发起的请求，服务端就会有响应，最后吐给前端</p>
<p>利用inspect反复分析内存，经过代码追踪，请求受阻，settimeout 代码不执行，被挂起，无法释放</p>
<p>axios 超时</p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">对于node来说，（代码块被挂起）cpu上升的原因有：settimeout，IO阻塞，express没调用res.end()结束请求。</span><br><span class="line"></span><br><span class="line">压测后发现的现象：在服务器超载的情况下，由于无法做出响应，客户端的socket就会被挂起一直处于connection状态。</span><br></pre></td></tr></table></figure>

<ul>
<li><p>结论：</p>
<p>有时，响应会很慢，并且没有响应，就是连接事件将被事件循环系统阻塞。</p>
<p>由于Node中，io链接会阻塞timer处理，因此这个setTimeout不会按时触发，也就有了超过了设定的超时时间以上才返回的情况。阻塞的connection导致请求堆积，服务器处理不过来，CPU也就下不来。</p>
</li>
<li><p>解决：</p>
</li>
</ul>
<p>利用socket中对于connect的超时处理来代替会在Nodejs中被阻塞的setTimeout来处理超时请求。</p>
<p>另一个暴力方案，采用pm2 start app.js –max-memory-restart 20M，声明应用在超过使用内存上限后自动重启</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>在vue-ssr中造成内存和cpu泄露的原因：</p>
<ul>
<li>挂起的socket造成的暂时性的堵塞</li>
<li>vue-router中的timer在某些情况下会陷入死循环</li>
<li>大量的模板编译，内存中会存留大量被字符串占用的内存</li>
</ul>
<p>解决方案：</p>
<ul>
<li>移除component中对于beforeRouteEnter的处理。将这里的处理移到其他地方，从vue-router代码层面分析是可以避免陷入timer的死循环的。</li>
<li>在nodejs中替换掉setTimeout的方式去处理服务器端请求超时，改用http.request的timeout事件handle来处理。防止io阻塞timer处理。</li>
<li>如果不是对seo要求过高，采用骨架页渲染的方式，向客户端渲染出骨架页，然后由前端直接发起ajax请求拉取服务器数据。避免在nodejs端执行服务端请求由于服务端后台无法响应造成堵塞导致部分链接被挂起。（nodejs的事件循环和浏览器是不同的，虽然都是基于V8引擎。这也是大部分国内互联网公司在vue-ssr这块的普遍应用方式）</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/12/RPC-REST/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Laurel">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Laurel Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/12/RPC-REST/" itemprop="url">RPC-REST</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-12T10:15:36+08:00">
                2019-04-12
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/server/" itemprop="url" rel="index">
                    <span itemprop="name">server</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="RPC"><a href="#RPC" class="headerlink" title="RPC"></a>RPC</h3><p>远程调用框架（Remote Procedure Call），被调用方法的具体实现不在程序运行本地，而是在别的某个远程地方</p>
<ol>
<li>远程调用原理： A (client) 调用 B (server) 提供的方法<ul>
<li>首先A与B之间建立一个TCP连接；</li>
<li>然后A把需要调用的方法名以及方法参数序列化成字节流发送出去；</li>
<li>B接受A发送过来的字节流，然后反序列化得到目标方法名，方法参数，接着执行相应的方法调用并把结果返回；</li>
<li>A接受远程调用结果,输出结果</li>
</ul>
</li>
</ol>
<p><strong>RPC框架就是把这几点细节给封装起来，给用户暴露简单友好的API使用</strong></p>
<ol>
<li><p>好处：</p>
<p>解耦：当server需要对方法内实现修改时，client完全感知不到，不用做任何变更；这种方式在跨部门，跨公司合作的时候经常用到，并且方法的提供者我们通常称为：服务的暴露</p>
</li>
</ol>
<h3 id="RESTful-API"><a href="#RESTful-API" class="headerlink" title="RESTful API"></a>RESTful API</h3><p> RESTful 是目前最流行的 API 设计规范，用于 Web 数据接口的设计</p>
<p> REST – REpresentational State Transfer：表现层状态转移。资源在网络中以某种表现形式进行状态转移。分解开来：</p>
<ul>
<li>Resource：资源，即数据（前面说过网络的核心）。比如 newsfeed，friends等；</li>
<li>Representational：某种表现形式，比如用JSON，XML，JPEG等；</li>
<li>State Transfer：状态变化。通过HTTP动词实现。</li>
</ul>
<h3 id="URL设计"><a href="#URL设计" class="headerlink" title="URL设计"></a>URL设计</h3><ol>
<li><p>RESTful 的核心思想是客户端发出的数据操作指令都是”动词 + 宾语”的结构</p>
<p>动词通常就是五种 HTTP 方法，对应 CRUD 操作：</p>
<ul>
<li>GET：读取（Read）</li>
<li>POST：新建（Create）</li>
<li>PUT：更新（Update）</li>
<li>PATCH：更新（Update），通常是部分更新</li>
<li>DELETE：删除（Delete）</li>
</ul>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">宾语就是 API 的 URL，是 HTTP 动词作用的对象。</span><br></pre></td></tr></table></figure>

<ol>
<li><p>状态码必须精确</p>
<p>HTTP状态码，分5个类别：</p>
<ul>
<li>1xx：相关信息</li>
<li>2xx：操作成功</li>
<li>3xx：重定向</li>
<li>4xx：客户端错误</li>
<li>5xx：服务器错误</li>
</ul>
</li>
<li><p>服务器回应</p>
<ul>
<li>API 返回的数据格式不应是纯本文，而应该是一个 JSON 对象（Content-Type属性设为application/json）</li>
<li>发生错误时，不要返回 200 状态码：状态码反映发生的错误，具体的错误信息放在数据体里面返回</li>
<li>提供链接：API 的使用者未必知道，URL 是怎么设计的。解决方法就是，在回应中，给出相关链接，便于下一步操作</li>
</ul>
</li>
</ol>
<h2 id="RPC与REST有什么区别"><a href="#RPC与REST有什么区别" class="headerlink" title="RPC与REST有什么区别"></a>RPC与REST有什么区别</h2><p>RPC是client/server模式的，调用远程的方法，REST也是一套API调用协议方法，它也是基于client/server模式的，调用远程的方法的。</p>
<p>REST API 和 RPC 都是在 Server端 把一个个函数封装成接口暴露出去，以供 Client端 调用，但REST API 是基于HTTP协议的，REST致力于通过http协议中的POST/GET/PUT/DELETE等方法和一个可读性强的URL来提供一个http请求。而 RPC 则可以不基于 HTTP协议<br>因此，如果是后端两种语言互相调用，用 RPC 可以获得更好的性能（省去了 HTTP 报头等一系列东西），应该也更容易配置</p>
<p>Link:</p>
<ul>
<li><a href="http://www.ruanyifeng.com/blog/2018/10/restful-api-best-practices.html" target="_blank" rel="noopener">http://www.ruanyifeng.com/blog/2018/10/restful-api-best-practices.html</a></li>
<li><a href="https://blog.csdn.net/cs958903980/article/details/78674087" target="_blank" rel="noopener">https://blog.csdn.net/cs958903980/article/details/78674087</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/12/express/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Laurel">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Laurel Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/12/express/" itemprop="url">express</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-12T10:10:30+08:00">
                2019-04-12
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/node-framework/" itemprop="url" rel="index">
                    <span itemprop="name">node-framework</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一、内容"><a href="#一、内容" class="headerlink" title="一、内容"></a>一、内容</h2><p>Express是一个node.js Web应用框架，提供了一系列特性帮助创建各种web应用，和丰富的HTTP工具。</p>
<p>Express 框架核心特性：</p>
<ul>
<li>可以设置中间件来相应HTTP请求；</li>
<li>定义了路由表用于执行不同的HTTP请求动作；</li>
<li>可以通过向模块传递参数来动态渲染HTML页面</li>
</ul>
<p>安装Express： npm install express –save</p>
<p>安装Express框架时，需与以下几个模块一起安装：</p>
<ul>
<li>body-parser：node.js 中间件，用于处理 JSON, Raw, Text 和 URL 编码的数据。</li>
<li>cookie-parser： 是一个解析Cookie的工具。通过req.cookies可以取到传过来的cookie，并把它们转成对象。</li>
<li>multer： node.js 中间件，用于处理 enctype=”multipart/form-data”（设置表单的MIME编码）的表单数据。</li>
</ul>
<p>请求和响应：</p>
<p>Express 应用使用回调函数的参数： request 和 response 对象来处理请求和响应的数据。</p>
<ul>
<li>Request 对象 - request 对象表示 HTTP 请求，包含了请求查询字符串，参数，内容，HTTP 头部等属性。常见属性有：<ul>
<li>req.app：当callback为外部文件时，用req.app访问express的实例</li>
<li>req.baseUrl：获取路由当前安装的URL路径</li>
<li>req.body / req.cookies：获得「请求主体」/ Cookies</li>
<li>req.fresh / req.stale：判断请求是否还「新鲜」</li>
<li>req.hostname / req.ip：获取主机名和IP地址</li>
<li>req.originalUrl：获取原始请求URL</li>
<li>req.params：获取路由的parameters</li>
<li>req.path：获取请求路径</li>
<li>req.protocol：获取协议类型</li>
<li>req.query：获取URL的查询参数串</li>
<li>req.route：获取当前匹配的路由</li>
<li>req.subdomains：获取子域名</li>
<li>req.accepts()：检查可接受的请求的文档类型</li>
<li>req.acceptsCharsets / req.acceptsEncodings / req.acceptsLanguages：返回指定字符集的第一个可接受字符编码</li>
<li>req.get()：获取指定的HTTP请求头</li>
<li>req.is()：判断请求头Content-Type的MIME类型</li>
</ul>
</li>
<li>Response 对象 - response 对象表示 HTTP 响应，即在接收到请求时向客户端发送的 HTTP 响应数据。常见属性有：<ul>
<li>res.app：同req.app一样</li>
<li>res.append()：追加指定HTTP头</li>
<li>res.set()在res.append()后将重置之前设置的头</li>
<li>res.cookie(name，value [，option])：设置Cookie<br>opition: domain / expires / httpOnly / maxAge / path / secure / signed</li>
<li>res.clearCookie()：清除Cookie</li>
<li>res.download()：传送指定路径的文件</li>
<li>res.get()：返回指定的HTTP头</li>
<li>res.json()：传送JSON响应</li>
<li>res.jsonp()：传送JSONP响应</li>
<li>res.location()：只设置响应的Location HTTP头，不设置状态码或者close response</li>
<li>res.redirect()：设置响应的Location HTTP头，并且设置状态码302</li>
<li>res.render(view,[locals],callback)：渲染一个view，同时向callback传递渲染后的字符串，如果在渲染过程中有错误发生next(err)将会被自动调用。callback将会被传入一个可能发生的错误以及渲染后的页面，这样就不会自动输出了。</li>
<li>res.send()：传送HTTP响应</li>
<li>res.sendFile(path [，options] [，fn])：传送指定路径的文件 -会自动根据文件extension设定Content-Type</li>
<li>res.set()：设置HTTP头，传入object可以一次设置多个头</li>
<li>res.status()：设置HTTP状态码</li>
<li>res.type()：设置Content-Type的MIME类型</li>
</ul>
</li>
</ul>
<h2 id="二、guide"><a href="#二、guide" class="headerlink" title="二、guide"></a>二、guide</h2><h3 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h3><ol>
<li><p>路由表示应用程序端点（URI）的定义以及端点响应客户机请求的方式。决定了由谁(指定脚本)去响应客户端请求</p>
</li>
<li><p>路由方法</p>
<p>路由方法派生自HTTP方法之一，附加到express类的实例。</p>
<ul>
<li><p>Express 支持对应于HTTP方法的以下路由方法：get、post、put…</p>
<p>app.get(‘/‘, function )</p>
</li>
<li><p>特殊的路由方法：app.all()，并非派生自HTTP方法。该方法用于在所有请求方法的路径中装入中间件函数。</p>
<p>app.all(‘/‘, function (req, res){</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">next();</span><br></pre></td></tr></table></figure>

<p>})</p>
</li>
</ul>
</li>
<li><p>路由路径</p>
<p>路由路径和请求方法相结合， 用于定义可以在其中提出请求的端点。路由路径可以是字符串、字符串模式或正则表达式。</p>
<p>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">app.get(&apos;/&apos;, function (req, res) &#123; // demo01:（此路由路径将请求与跟路由/匹配）</span><br><span class="line">    res.send(&apos;root&apos;);</span><br><span class="line">&#125;);</span><br><span class="line">app.get(&apos;/ab?cd&apos;, function(req, res) &#123; // demo02: （路由路径将匹配acd和abcd）</span><br><span class="line">    res.send(&apos;ab?cd&apos;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>路由处理程序（中间件系统）<br>可以提供多个回调函数，类似于中间件的行为方式来处理请求。这些回调函数可能调用next(‘route’)来绕过剩余的路由回调。</p>
<ul>
<li><p>路由处理程序的形式可以是一个函数、一组函数或者两者的结合。</p>
</li>
<li><p>多个回调函数可以处理一个路由（确保指定next对象）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">app.get(&apos;/example/b&apos;, function (req, res, next) &#123;</span><br><span class="line">    console.log(&apos;lala&apos;);</span><br><span class="line">    next();</span><br><span class="line">&#125;, function (req, res) &#123;</span><br><span class="line">    res.send(&apos;Hello&apos;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>一组回调函数可以处理一个路由</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">var cb0 = function (req, res, next) &#123;</span><br><span class="line">    console.log(&apos;cb0&apos;);</span><br><span class="line">    next();</span><br><span class="line">&#125;</span><br><span class="line">var cb1 = function (req, res, next) &#123;</span><br><span class="line">    console.log(&apos;cb1&apos;);</span><br><span class="line">    next();</span><br><span class="line">&#125;</span><br><span class="line">var cb2 = function (req, res, next) &#123;</span><br><span class="line">    res.send(&apos;Hello from 2&apos;);</span><br><span class="line">&#125;</span><br><span class="line">app.get(&apos;/example/c&apos;, [cb0, cb1, cb2])</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>响应方法</p>
<p>响应对象(res)的方法可以向客户机发送响应，并终止请求/响应循环。如没有从路由处理程序调起其中任何方法，客户机请求将保持挂起状态。</p>
<ul>
<li>res.download() // 提示将要下载文件</li>
<li>res.end() // 结束响应</li>
<li>res.json() // 发送JSON响应</li>
<li>res.jsonp() // 在JSONP的支持下发送JSON响应</li>
<li>res.redirect() // 重定向请求</li>
<li>res.render() // 呈现视图模板</li>
<li>res.send() // 发送各种类型的响应</li>
<li>res.sendFile() // 以八位元流形式发送文件。</li>
<li>res.sendStatus() // 设置响应状态码并以响应主体形式发送其字符串表示</li>
</ul>
</li>
<li><p>app.route()</p>
<p>使用app.route()为路由路径创建可链接的路由处理程序。在单一位置指定路径，可减少冗余和输入错误。</p>
<p>使用app.route()定义的链式路由处理程序的示例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">app.route(&apos;/book&apos;)</span><br><span class="line">    .get(function(req, res) &#123;</span><br><span class="line">        res.send(&apos;Get a data&apos;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .post(function(req, res) &#123;</span><br><span class="line">        res.send(&apos;Add a data&apos;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .put(function(req, res) &#123;</span><br><span class="line">        res.send(&apos;update a data&apos;);</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>express.Router</p>
<p>使用express.Router类来创建可安装的模块化路由程序。Router实例是完整的中间件和路由系统；</p>
</li>
<li><p>编写中间件用于Express 应用程序</p>
<p>中间件函数能够访问请求对象（req），响应对象（res）以及应用程序的请求/响应循环中的下一个中间函数。下一个中间件函数通常由名为 next 的变量来表示。</p>
</li>
</ol>
<ul>
<li>中间件函数可以执行任务：<ul>
<li>执行任何代码</li>
<li>对请求和响应对象进行更改。</li>
<li>结束请求/响应循环。</li>
<li>调用堆栈中的下一个中间件函数</li>
</ul>
</li>
<li>中间件类型：<ul>
<li>应用层中间件</li>
<li>路由层中间件</li>
<li>错误处理中间件</li>
<li>内置中间件</li>
<li>第三方中间件</li>
</ul>
</li>
<li>应用层中间件<ol>
<li>使用app.use()和app.METHOD()函数将应用层中间件绑定到应用程序对象的实例（METHOD是中间件函数处理的请求的小写HTTP方法：GET、PUT 或 POST）</li>
<li>一般有两种参数：路由路径及其处理程序函数(中间件系统)</li>
<li>跳过路由器中间件堆栈中剩余的中间件函数，调用 next(‘route’) 将控制权传递给下一个路由。仅在使用 app.METHOD() 或 router.METHOD() 函数装入的中间件函数中有效。</li>
</ol>
</li>
<li>路由层中间件： 使用 router.use() 和 router.METHOD() 函数装入路由器层中间件</li>
<li>错误处理中间件：错误处理函数有四个自变量而不是三个，专门具有特征符 (err, req, res, next)</li>
<li>内置中间件</li>
<li>第三方中间件：使用第三方中间件向 Express 应用程序添加功能。<ul>
<li>安装具有所需功能的 Node.js 模块，然后在应用层或路由器层的应用程序中将其加装入。</li>
<li>第三方中间件列表：<ul>
<li>body-parser</li>
<li>cookie-parser</li>
<li>cookie-session</li>
<li>passport：用于认证的 Express 中间件模块</li>
<li>serve-static：用于提供静态内容的模块</li>
<li>express-session</li>
</ul>
</li>
</ul>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/12/Express-vs-Koa/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Laurel">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Laurel Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/12/Express-vs-Koa/" itemprop="url">Express-vs-Koa</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-12T10:00:58+08:00">
                2019-04-12
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/node-framework/" itemprop="url" rel="index">
                    <span itemprop="name">node-framework</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/node-framework/interview/" itemprop="url" rel="index">
                    <span itemprop="name">interview</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Node框架"><a href="#Node框架" class="headerlink" title="Node框架"></a>Node框架</h2><ul>
<li>Express，是一个基于Node.js平台的极简、灵活的web应用开发框架，主要基于Connect中间件，并且自身封装了路由、视图处理等功能，使用人数众多。</li>
<li>Koa，主要基于co中间件，框架自身不包含任何中间件，很多功能需要借助第三方中间件解决。Express的团队又基于ES6的新特性重新开发web框架koa<ul>
<li>和Express相比，koa 1.0使用generator实现异步，代码看起来像同步的，解决了 “callback hell” 和麻烦的错误处理问题。</li>
<li>generator的本意并不是异步，koa团队又非常超前地基于ES7开发了koa2，和koa 1相比，koa2完全使用Promise并配合async来实现异步</li>
</ul>
</li>
</ul>
<h3 id="具体示例差别"><a href="#具体示例差别" class="headerlink" title="具体示例差别"></a>具体示例差别</h3><ol>
<li><p>创建一个基础的Web服务（两者的区别是路由处理Express是自身集成的，而Koa需要引入中间件）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. Express</span></span><br><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">var</span> app = express()</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    res.send(<span class="string">'express'</span>)</span><br><span class="line">&#125;)</span><br><span class="line">app.listen(<span class="number">3000</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. Koa</span></span><br><span class="line"><span class="keyword">var</span> koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">var</span> route = <span class="built_in">require</span>(<span class="string">'koa-route'</span>)</span><br><span class="line"><span class="keyword">var</span> app = koa()</span><br><span class="line"></span><br><span class="line">app.use(route.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> *(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.body = <span class="string">'koa'</span></span><br><span class="line">&#125;))</span><br><span class="line">app.listen(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>Views</p>
<ul>
<li><p>Express自身集成了视图功能，提供了consolidate.js功能，支持几乎所有JS模板引擎，并提供了视图设置的便利方法</p>
</li>
<li><p>Koa需要引入co-views中间件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. Express</span></span><br><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>)</span><br><span class="line"><span class="keyword">var</span> app = express()</span><br><span class="line"></span><br><span class="line">app.set(<span class="string">'views'</span>, __dirname + <span class="string">'/views'</span>)</span><br><span class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'jade'</span>)</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">res.render(<span class="string">'index'</span>, &#123;</span><br><span class="line">    title: <span class="string">'bilibili'</span></span><br><span class="line">&#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. Koa</span></span><br><span class="line"><span class="keyword">var</span> koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">var</span> route = <span class="built_in">require</span>(<span class="string">'koa-route'</span>)</span><br><span class="line"><span class="keyword">var</span> views = <span class="built_in">require</span>(<span class="string">'co-views'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> render = views(__dirname + <span class="string">'/views'</span>, &#123;</span><br><span class="line"><span class="keyword">default</span>: <span class="string">"jade"</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> app = koa()</span><br><span class="line"></span><br><span class="line">app.use(route.get(<span class="string">'/'</span>, <span class="function"><span class="keyword">function</span> *(<span class="params"></span>) </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.body = <span class="keyword">yield</span> render(<span class="string">'index'</span>, &#123;</span><br><span class="line">    title: <span class="string">'bilibili'</span></span><br><span class="line">&#125;)</span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>HTTP Request<br>两个框架都封装了HTTP Request对象，区别是Koa v1使用this取代Express的req、res</p>
</li>
</ol>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. Express</span></span><br><span class="line"><span class="keyword">var</span> app = <span class="built_in">require</span>(<span class="string">'express'</span>)()</span><br><span class="line"></span><br><span class="line">app.get(<span class="string">'/room/:id'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(req.params)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取post数据需要body-parser中间件</span></span><br><span class="line"><span class="keyword">var</span> bodyParser = <span class="built_in">require</span>(<span class="string">'body-parser'</span>)</span><br><span class="line">app.use(bodyParser.json())</span><br><span class="line">app.post(<span class="string">'/sendapi'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(req.body)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. Koa</span></span><br><span class="line"><span class="keyword">var</span> app = <span class="built_in">require</span>(<span class="string">'koa'</span>)()</span><br><span class="line"><span class="keyword">var</span> route = <span class="built_in">require</span>(<span class="string">'koa-route'</span>)</span><br><span class="line"></span><br><span class="line">app.use(route.get(<span class="string">'/room/:id'</span>, <span class="function"><span class="keyword">function</span> *(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.req.query)</span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取POST数据需要co-body中间件</span></span><br><span class="line"><span class="keyword">var</span> parse = <span class="built_in">require</span>(<span class="string">'co-body'</span>)</span><br><span class="line">app.use(route.post(<span class="string">'/api'</span>, <span class="function"><span class="keyword">function</span> *(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> post = yeild parse(<span class="keyword">this</span>.request)</span><br><span class="line">    <span class="built_in">console</span>.log(post)</span><br><span class="line">&#125;))</span><br></pre></td></tr></table></figure>

<h3 id="Express-和-Koa的区别"><a href="#Express-和-Koa的区别" class="headerlink" title="Express 和 Koa的区别"></a>Express 和 Koa的区别</h3><ol>
<li>异步流程控制<ul>
<li>Express采用callback来处理异步，Koa v1采用generator，Koa v2采用async/await.</li>
<li>generator和async/await使用同步的写法来处理异步，明显好于callback和promise；</li>
<li>async/await在语义化上又要比generator更强</li>
</ul>
</li>
<li>错误处理<ul>
<li>Express使用callback捕获异常，对于深层次的异常捕获不了</li>
<li>Koa使用try catch，能更好地解决异常捕获</li>
</ul>
</li>
<li>总结<ul>
<li>Express<ul>
<li>优点：线性逻辑，通过中间件形式把业务逻辑细分、简化，一个请求进来经过一系列中间件处理后再响应给用户，清晰明了。</li>
<li>缺点：基于 callback 组合业务逻辑，业务逻辑复杂时嵌套过多，异常捕获困难。</li>
</ul>
</li>
<li>Koa<ul>
<li>优点：首先，借助 co 和 generator，很好地解决了异步流程控制和异常捕获问题。其次，Koa 把 Express 中内置的 router、view 等功能都移除了，使得框架本身更轻量。</li>
<li>缺点：社区相对较小</li>
</ul>
</li>
<li>koa的中间件模式与express不一样，koa是洋葱型，express是直线型<ul>
<li></li>
</ul>
</li>
</ul>
</li>
</ol>
<h2 id="Koa框架"><a href="#Koa框架" class="headerlink" title="Koa框架"></a>Koa框架</h2><p>Koa 就是一种简单好用的 Web 框架。它的特点是优雅、简洁、表达力强、自由度高。所有功能都通过插件实现</p>
<p>检查Node版本，Koa必须使用7.6以上的版本。</p>
<h3 id="用法："><a href="#用法：" class="headerlink" title="用法："></a>用法：</h3><ul>
<li>架设HTTP服务： var app = new Koa(); app.listen(3000)</li>
<li>Context对象：标识一次对话的上下文(包括HTTP请求和回复)。通过加工这个对象，可以控制返回给用户的内容<ul>
<li>Context.response.body属性就是发送给用户的内容</li>
<li>ctx.request代表 HTTP Request；ctx.response代表 HTTP Response</li>
</ul>
</li>
<li>HTTP response的类型<ul>
<li>Koa默认返回的类型是text/plain</li>
<li>若想要返回其他类型的内容，可以先用ctx.request.accepts判断客户端希望接受的数据类型（根据HTTP Request的Accept字段），然后使用ctx.response.type指定返回类型</li>
</ul>
</li>
<li>网页模板<br>实际开发中，返回给用户的网页都写成模板文件。可以先让Koa限度无模板文件，然后将这个模板返回给用户。</li>
</ul>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> main = <span class="function"><span class="params">ctx</span> =&gt;</span> &#123;</span><br><span class="line">    ctx.response.type = <span class="string">'html'</span>;</span><br><span class="line">    ctx.response.body = fs.createReadStream(<span class="string">'./demos/template.html'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h3><ul>
<li><p>原生路由</p>
<p>网站一般都有多个页面。通过ctx.request.path可以获取用户请求的路径，由此实现简单的路由。</p>
</li>
<li><p>koa-route模块</p>
<p>使用封装好的koa-route模块</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> route = <span class="built_in">require</span>(<span class="string">'koa-route'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> main = <span class="function"><span class="params">ctx</span> =&gt;</span> &#123;</span><br><span class="line">    ctx.response.body = <span class="string">'Hello World'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.use(route.get(<span class="string">'/'</span>, main));</span><br></pre></td></tr></table></figure>
</li>
<li><p>静态资源</p>
<p>koa-static模块封装静态资源的请求</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> serve = <span class="built_in">require</span>(<span class="string">'koa-static'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> main = serve(path.join(__dirname));</span><br><span class="line">app.use(main);</span><br></pre></td></tr></table></figure>
</li>
<li><p>重定向<br>服务器需要重定向（redirect）访问请求。ctx.response.redirect()方法可以发出一个302跳转。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> redirect = <span class="function"><span class="params">ctx</span> =&gt;</span> &#123;</span><br><span class="line">    ctx.response.redirect(<span class="string">'/'</span>);</span><br><span class="line">    ctx.response.body = <span class="string">'&lt;a href="/"&gt;Index Page&lt;/a&gt;'</span>;</span><br><span class="line">&#125;;</span><br><span class="line">app.use(route.get(<span class="string">'/redirect'</span>, redirect));</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="中间件"><a href="#中间件" class="headerlink" title="中间件"></a>中间件</h3><ul>
<li><p>Logger功能</p>
<p>Logger功能可以拆分成一个独立函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> logger = <span class="function">(<span class="params">ctx, next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;<span class="built_in">Date</span>.now()&#125;</span> <span class="subst">$&#123;ctx.request.method&#125;</span> <span class="subst">$&#123;ctx.request.url&#125;</span>`</span>);</span><br><span class="line">    next();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">app.use(logger);</span><br></pre></td></tr></table></figure>
</li>
<li><p>中间件</p>
<p>如上述的logger函数就叫‘中间件’，它处于HTTP Request和HTTP Response中间，用来实现某种中间功能。app.use()用来加载中间件。</p>
<p>Koa 所有的功能都是通过中间件实现的。每个中间件默认接受两个参数，第一个参数是 Context 对象，第二个参数是next函数。只要调用next函数，就可以把执行权转交给下一个中间件。</p>
</li>
<li><p>中间件栈</p>
<p>多个中间件栈会形成一个栈结构，以“先进先出”的顺序执行。</p>
<p>如果中间件内部没有调用next函数，那么执行权就不会传递下去</p>
<blockquote>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">最外层的中间件首先执行。</span><br><span class="line">调用next函数，把执行权交给下一个中间件。</span><br><span class="line">...</span><br><span class="line">最内层的中间件最后执行。</span><br><span class="line">执行结束后，把执行权交回上一层的中间件。</span><br><span class="line">...</span><br><span class="line">最外层的中间件收回执行权之后，执行next函数后面的代码。</span><br></pre></td></tr></table></figure>
</li>
<li><p>异步中间件</p>
<p>有异步操作（比如读取数据库），中间件就必须写成 async 函数。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs.promised'</span>);</span><br><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>);</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Koa();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> main = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> (<span class="params">ctx, next</span>) </span>&#123;</span><br><span class="line">    ctx.response.type = <span class="string">'html'</span>;</span><br><span class="line">    ctx.response.body = <span class="keyword">await</span> fs.readFile(<span class="string">'./demos/template.html'</span>, <span class="string">'utf8'</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">app.use(main);</span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>中间件的合成</p>
<p>koa-compose模块可以将多个中间件合成为一个。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> compose = <span class="built_in">require</span>(<span class="string">'koa-compose'</span>);</span><br><span class="line"><span class="keyword">const</span> middlewares = compose([logger, main]);</span><br><span class="line">app.use(middlewares);</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h3><ul>
<li><p>500错误</p>
<p>koa 提供了ctx.throw()方法，用来抛出错误，ctx.throw(500)就是抛出500错误</p>
</li>
<li><p>404错误</p>
<p>如果将ctx.response.status设置成404，就相当于ctx.throw(404)</p>
</li>
<li><p>处理错误的中间件</p>
<p>使用try…catch将其捕获</p>
<p>让最外层的中间件，负责所有中间件的错误处理</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> handler = <span class="keyword">async</span> (ctx, next) =&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">await</span> next();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        ctx.response.status = err.statusCode || err.status || <span class="number">500</span>;</span><br><span class="line">        ctx.response.body = &#123;</span><br><span class="line">            message: err.message</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">app.use(handler);</span><br></pre></td></tr></table></figure>
</li>
<li><p>error事件的监听</p>
<p>运行过程中一旦出错，Koa 会触发一个error事件。监听这个事件，也可以处理错误。</p>
</li>
<li><p>释放 error 事件</p>
<p>如果错误被try…catch捕获，就不会触发error事件。这时，必须调用ctx.app.emit()，手动释放error事件，才能让监听函数生效。</p>
</li>
</ul>
<h3 id="Web-App的功能"><a href="#Web-App的功能" class="headerlink" title="Web App的功能"></a>Web App的功能</h3><ul>
<li><p>Cookies</p>
<p>ctx.cookie用来读写Cookie。ctx.cookies.set();</p>
</li>
<li><p>表单</p>
<p>表单就是 POST 方法发送到服务器的键值对。koa-body模块可以用来从 POST 请求的数据体里面提取键值对。</p>
</li>
<li><p>文件上传</p>
<p>koa-body模块还可以用来处理文件上传</p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/02/JSCode-Test/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Laurel">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Laurel Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/02/JSCode-Test/" itemprop="url">JSCode-Test</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-04-02T11:38:01+08:00">
                2019-04-02
              </time>
            

            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/interview/" itemprop="url" rel="index">
                    <span itemprop="name">interview</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="异步队列类"><a href="#异步队列类" class="headerlink" title="异步队列类"></a>异步队列类</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    TaskQe = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._arrayFn = [];  <span class="comment">// 事件集合 </span></span><br><span class="line">        <span class="keyword">this</span>._callback = &#123;&#125;; <span class="comment">// 事件回调</span></span><br><span class="line">        <span class="keyword">this</span>._backdata = []; <span class="comment">// 返回数据集合</span></span><br><span class="line">        <span class="keyword">this</span>._isParallel = <span class="literal">false</span>; <span class="comment">// 是否并行，默认否 </span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 加入队列</span></span><br><span class="line">    TaskQe.prototype.add = <span class="function"><span class="keyword">function</span> (<span class="params">fn</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>._arrayFn.push(fn);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 队列数目</span></span><br><span class="line">    TaskQe.prototype.size = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>._arrayFn.length;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取返回数据集合</span></span><br><span class="line">    TaskQe.prototype.getCallBack = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>._backdata;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 依次运行队列</span></span><br><span class="line">    TaskQe.prototype.next = <span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> fn = <span class="keyword">this</span>.getNext()；</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 并行 or 串行</span></span><br><span class="line">        (<span class="keyword">this</span>._isParallel)</span><br><span class="line">            ? ((fn) &amp;&amp;fn())</span><br><span class="line">        	: ((fn) &amp;&amp; ((data) ? fn(data): fn()))</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 集合返回数据</span></span><br><span class="line">        (data) ? <span class="keyword">this</span>._backdata.push(data) : <span class="keyword">this</span>._backdata.push(<span class="literal">false</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 返回总回调</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.size() &amp;&amp; !fn) &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="keyword">this</span>._callback === <span class="string">"function"</span>) &#123;</span><br><span class="line">                (data) ? <span class="keyword">this</span>._callback(data) : <span class="keyword">this</span>._callback();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 队列执行</span></span><br><span class="line">    TaskQe.prototype.getNext = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.size()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.arrayFn.shift();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 初始化，完成后执行，第一个参数是否执行，第二个参数返回</span></span><br><span class="line">    TaskQe.prototype.run = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">arguments</span>.length === <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>._callback = (<span class="keyword">typeof</span> <span class="built_in">arguments</span>[<span class="number">0</span>] === <span class="string">"function"</span>) ? <span class="built_in">arguments</span>[<span class="number">0</span>] : &#123;&#125;;</span><br><span class="line">            <span class="keyword">this</span>._isParallel = (<span class="keyword">typeof</span> <span class="built_in">arguments</span>[<span class="number">0</span>] === <span class="string">"boolean"</span>) ? <span class="built_in">arguments</span>[<span class="number">0</span>] :<span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">arguments</span>.length === <span class="number">2</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>._callback = (<span class="keyword">typeof</span> <span class="built_in">arguments</span>[<span class="number">1</span>] === <span class="string">"function"</span>) ? <span class="built_in">arguments</span>[<span class="number">1</span>] : &#123;&#125;;</span><br><span class="line">            <span class="keyword">this</span>._isParallel = (<span class="keyword">typeof</span> <span class="built_in">arguments</span>[<span class="number">0</span>] === <span class="string">"boolean"</span>) ? <span class="built_in">arguments</span>[<span class="number">0</span>] :<span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> firstFn = <span class="keyword">this</span>.getNext();</span><br><span class="line">        firstFn();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> TaskQe;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>

<h3 id="实现一个Event类"><a href="#实现一个Event类" class="headerlink" title="实现一个Event类"></a>实现一个Event类</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实现一个event类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">EventEmitter</span></span>&#123;</span><br><span class="line">    <span class="keyword">constructor</span>()&#123;</span><br><span class="line">        <span class="keyword">this</span>._events=&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    on(event,callback)&#123;</span><br><span class="line">        <span class="keyword">let</span> callbacks = <span class="keyword">this</span>._events[event] || []</span><br><span class="line">        callbacks.push(callback)</span><br><span class="line">        <span class="keyword">this</span>._events[event] = callbacks</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">    &#125;</span><br><span class="line">    off(event,callback)&#123;</span><br><span class="line">        <span class="keyword">let</span> callbacks = <span class="keyword">this</span>._events[event]</span><br><span class="line">        <span class="keyword">this</span>._events[event] = callbacks &amp;&amp; callbacks.filter(<span class="function"><span class="params">fn</span> =&gt;</span> fn !== callback)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">    &#125;</span><br><span class="line">    emit(...args)&#123;</span><br><span class="line">        <span class="keyword">const</span> event = args[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">const</span> params = [].slice.call(args,<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">const</span> callbacks = <span class="keyword">this</span>._events[event]</span><br><span class="line">        callbacks.forEach(<span class="function"><span class="params">fn</span> =&gt;</span> fn.apply(<span class="keyword">this</span>, params))</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">    &#125;</span><br><span class="line">    once(event,callback)&#123;</span><br><span class="line">        <span class="keyword">let</span> wrapFunc = <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">            callback.apply(<span class="keyword">this</span>,args)</span><br><span class="line">            <span class="keyword">this</span>.off(event,wrapFunc)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.on(event,wrapFunc)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试</span></span><br><span class="line"><span class="keyword">let</span> ee = <span class="keyword">new</span> EventEmitter();</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">a</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'a'</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">b</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'b'</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">c</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'c'</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">d</span>(<span class="params">...a</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'d'</span>,...a)</span><br><span class="line">&#125;</span><br><span class="line">ee.on(<span class="string">'TEST1'</span>, a).on(<span class="string">'TEST2'</span>, b).once(<span class="string">'TEST2'</span>, c).on(<span class="string">'TEST2'</span>,d);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ee.emit(<span class="string">'TEST1'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'....'</span>)</span><br><span class="line">ee.emit(<span class="string">'TEST2'</span>);</span><br><span class="line"><span class="comment">// In test2</span></span><br><span class="line"><span class="comment">// In test2 again</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'....'</span>)</span><br><span class="line">ee.emit(<span class="string">'TEST2'</span>);</span><br></pre></td></tr></table></figure>

<h3 id="1到N数字中由多少个1"><a href="#1到N数字中由多少个1" class="headerlink" title="1到N数字中由多少个1"></a>1到N数字中由多少个1</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">public <span class="keyword">static</span> <span class="keyword">void</span> main(<span class="built_in">String</span>[] args) &#123;</span><br><span class="line"></span><br><span class="line">long n = <span class="number">13</span>;</span><br><span class="line"></span><br><span class="line">int cnt = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (int i = <span class="number">1</span>; i &lt;= n; i++) &#123;</span><br><span class="line"></span><br><span class="line">cnt += count(i);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">System.out.println(cnt);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> int count(long number) &#123;</span><br><span class="line"></span><br><span class="line">int cnt = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (number &gt; <span class="number">0</span>) &#123;</span><br><span class="line"></span><br><span class="line">cnt += number % <span class="number">10</span> == <span class="number">1</span> ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">number /= <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> cnt;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params">n</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> cnt = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; n.length; i++) &#123;</span><br><span class="line">    cnt += count(i)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">count</span>(<span class="params">number</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> cnt = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span>(number &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    cnt += number % <span class="number">10</span> === <span class="number">1</span> ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    number = number / <span class="number">10</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> cnt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="实现bind"><a href="#实现bind" class="headerlink" title="实现bind"></a>实现bind</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">Function</span>.prototype.myBind = <span class="function"><span class="keyword">function</span> (<span class="params">context</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="keyword">this</span> !== <span class="string">'function'</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'Error'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">var</span> _this = <span class="keyword">this</span></span><br><span class="line">  <span class="keyword">var</span> args = [...arguments].slice(<span class="number">1</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">F</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span> <span class="keyword">instanceof</span> F) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> _this(...args, ..arguments)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> _this.apply(context, args.concat(...arguments))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="冒泡排序"><a href="#冒泡排序" class="headerlink" title="冒泡排序"></a>冒泡排序</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 冒泡排序</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">selection</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> len = arr.length;</span><br><span class="line">    <span class="keyword">var</span> temp;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len; i++ ) &#123;</span><br><span class="line">         <span class="keyword">for</span> (<span class="keyword">var</span> j = i + <span class="number">1</span>; j &lt; len; j++ ) &#123;</span><br><span class="line">             <span class="keyword">if</span> (arr[i] &gt; arr[j]) &#123;</span><br><span class="line">                 temp = arr[i];</span><br><span class="line">                 arr[i] = arr[j];</span><br><span class="line">                 arr[j] = temp;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> arr</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ret = selection([<span class="number">2</span>,<span class="number">34</span>,<span class="number">6</span>,<span class="number">1</span>])</span><br><span class="line"><span class="built_in">console</span>.info(ret)</span><br></pre></td></tr></table></figure>

<h3 id="promise实现"><a href="#promise实现" class="headerlink" title="promise实现"></a>promise实现</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 三种状态</span></span><br><span class="line"><span class="keyword">const</span> PENDING = <span class="string">'pending'</span>;</span><br><span class="line"><span class="keyword">const</span> RESOLVED = <span class="string">'resolved'</span>;</span><br><span class="line"><span class="keyword">const</span> REJECTED = <span class="string">'rejected'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyPromise</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> _this = <span class="keyword">this</span>;</span><br><span class="line">    _this.currentState = PENDING;</span><br><span class="line">    _this.value =  <span class="literal">undefined</span>;</span><br><span class="line">    _this.resolvedCallbacks = [];</span><br><span class="line">    _this.rejectedCallbacks = [];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    _this.resolve = <span class="function"><span class="keyword">function</span> (<span class="params">value</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (value <span class="keyword">instanceof</span> MyPromise) &#123;</span><br><span class="line">            <span class="keyword">return</span> value.then(_this.resolve, _this.reject)</span><br><span class="line">        &#125;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (_this.currentState === PENDING) &#123;</span><br><span class="line">                _this.currentState = RESOLVED;</span><br><span class="line">                _this.value = value;</span><br><span class="line">                _this.resolvedCallbacks.forEach(<span class="function"><span class="params">cb</span> =&gt;</span> cb());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    _this.reject = <span class="function"><span class="keyword">function</span> (<span class="params">reason</span>) </span>&#123;</span><br><span class="line">        setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (_this.currentState === PENDING) &#123;</span><br><span class="line">                _this.currentState = REJECTED;</span><br><span class="line">                _this.value = reason;</span><br><span class="line">                _this.rejectedCallbacks.forEach(<span class="function"><span class="params">cb</span> =&gt;</span> cb());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        fn(_this.resolve, _this.reject);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">        _this.reject(e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="最大公共子串"><a href="#最大公共子串" class="headerlink" title="最大公共子串"></a>最大公共子串</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findSubStr</span>(<span class="params">str1, str2</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (str1.length &gt; str2.length) &#123;</span><br><span class="line">      <span class="keyword">var</span> temp = str1;</span><br><span class="line">      str1 = str2;</span><br><span class="line">      str2 = temp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> len1 = str1.length,</span><br><span class="line">      len2 = str2.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> j = len1; j &gt; <span class="number">0</span>; j--) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; len2 - j; i++) &#123;</span><br><span class="line">        <span class="keyword">var</span> current = str1.substr(i, j);</span><br><span class="line">        <span class="keyword">if</span> (str2.indexOf(current) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> current;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="数组最大子段和"><a href="#数组最大子段和" class="headerlink" title="数组最大子段和"></a>数组最大子段和</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">maxSum</span>(<span class="params">arr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> current = <span class="number">0</span>,</span><br><span class="line">      sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; arr.length; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (current &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        current += arr[i];</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        current = arr[i];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (current &gt; sum) &#123;</span><br><span class="line">        sum = current;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="最长公共子序列的长度"><a href="#最长公共子序列的长度" class="headerlink" title="最长公共子序列的长度"></a>最长公共子序列的长度</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">lcs</span>(<span class="params">str1, str2</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> len1 = str1.length;</span><br><span class="line">    <span class="keyword">var</span> len2 = str2.length;</span><br><span class="line">    <span class="keyword">var</span> dp = []; <span class="comment">// 首先定义一个一维数组</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt;= len1; i++) &#123;</span><br><span class="line">      dp[i] = []; <span class="comment">// 将一维数组升级为二维数组</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt;= len2; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">0</span> || j == <span class="number">0</span>) &#123;</span><br><span class="line">          dp[i][j] = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (str1[i - <span class="number">1</span>] == str2[j - <span class="number">1</span>]) &#123; <span class="comment">// dp 的维度为 (len1+1)*(len2+1),str 的维度为 (len1)*(len2)</span></span><br><span class="line">          dp[i][j] = dp[i - <span class="number">1</span>][j - <span class="number">1</span>] + <span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          dp[i][j] = <span class="built_in">Math</span>.max(dp[i][j - <span class="number">1</span>], dp[i - <span class="number">1</span>][j]); <span class="comment">// 否则取当前位置上或左的最大数</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dp[len1][len2]; <span class="comment">// 返回二维数组最后一个值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="在一个数组中找出其中两项和相加后的和为num，存在时返回两个数的索引位置，否则false"><a href="#在一个数组中找出其中两项和相加后的和为num，存在时返回两个数的索引位置，否则false" class="headerlink" title="在一个数组中找出其中两项和相加后的和为num，存在时返回两个数的索引位置，否则false"></a>在一个数组中找出其中两项和相加后的和为num，存在时返回两个数的索引位置，否则false</h3><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fn</span>(<span class="params">num = <span class="number">0</span>, arr = []</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; arr.length; i++) &#123;</span><br><span class="line">        <span class="keyword">let</span> diff = num - arr[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">let</span> diffIndex = arr.indexOf(diff);</span><br><span class="line">        <span class="keyword">if</span> (diffIndex !== <span class="number">-1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> [i, diffIndex];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Laurel</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">45</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">tags</span>
                
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Laurel</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
